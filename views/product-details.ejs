<%- include('partials/header') %>

<style>
body {
    background: #f8f6f3;
}
.product-detail {
    display: grid;
    grid-template-columns: 60% 40%;
    min-height: 100vh;
    max-width: 100vw;
    margin: 0;
    background: #f8f6f3;
}
.product-image {
    background: #f8f6f3;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    height: 100vh;
    position: relative;
    padding: 40px;
}
.product-image img {
    width: 100%;
    height: calc(100vh - 80px);
    object-fit: contain;
    display: block;
    margin: 0;
    max-width: none;
    max-height: none;
}
.image-navigation {
    position: absolute;
    right: 24px;
    bottom: 120px;
    display: flex;
    gap: 12px;
    z-index: 2;
}
.nav-btn {
    background: rgba(0, 0, 0, 0.15);
    color: #fff;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    padding: 0;
}
.nav-btn:hover {
    background: rgba(0, 0, 0, 0.25);
}
.image-counter {
    position: absolute;
    bottom: 24px;
    left: 24px;
    color: #b0a99f;
    font-size: 14px;
    font-weight: 400;
    opacity: 1;
}
.product-info {
    background: #fff;
    border-left: 1px solid #ececec;
    padding: 60px 48px 48px 48px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 100vh;
    width: 100%;
    margin: 0;
}
.product-info h2 {
    font-size: 2.4rem;
    margin-bottom: 10px;
    font-weight: 700;
    color: #111;
    line-height: 1.1;
}
.product-rating {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 18px;
}
.rating-stars {
    color: #111;
    font-size: 18px;
}
.rating-count {
    color: #666;
    font-size: 15px;
}
.price {
    font-size: 1.6rem;
    margin-bottom: 2px;
    font-weight: 600;
    color: #111;
}
.taxes-info {
    color: #888;
    font-size: 13px;
    margin-bottom: 18px;
}
hr {
    border: none;
    border-top: 1px solid #ececec;
    margin: 24px 0 18px 0;
}
.variant-title {
    font-size: 15px;
    margin-bottom: 8px;
    font-weight: 600;
    color: #222;
}
.variant-images {
    display: flex;
    gap: 12px;
    margin-bottom: 18px;
}
.variant-image {
    width: 48px;
    height: 48px;
    border: 2px solid transparent;
    border-radius: 6px;
    cursor: pointer;
    padding: 2px;
    background: #f8f6f3;
    transition: border-color 0.2s;
}
.variant-image.selected {
    border-color: #111;
}
.size-selector {
    margin-bottom: 24px;
}
.size-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.size-title h3 {
    font-size: 15px;
    font-weight: 600;
    color: #222;
}
.size-guide {
    color: #111;
    text-decoration: underline;
    font-size: 13px;
}
.size-options {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
}
.size-button {
    background: #f8f6f3;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    padding: 12px 0;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}
.size-button:hover {
    border-color: #111;
}
.size-button.selected {
    background: #111;
    color: #fff;
    border-color: #111;
}
.add-to-cart {
    width: 100%;
    background: #b0a99f;
    color: #fff;
    padding: 18px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 18px;
    border-radius: 30px;
    transition: background 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}
.add-to-cart:not(:disabled) {
    background: #111;
    color: #fff;
}
.add-to-cart:disabled {
    background: #b0a99f;
    color: #fff;
    opacity: 1;
}
.shipping-info {
    color: #888;
    font-size: 13px;
    text-align: left;
    font-weight: 400;
    margin-top: 8px;
}
.related-products {
    padding: 60px 0;
    background: #fff;
    margin-top: 40px;
    border-top: 1px solid #f0f0f0;
}

.related-products .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.related-title {
    font-size: 28px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 40px;
    color: #111;
}

.related-products .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 30px;
    margin: 0 auto;
}

.related-products .product-card {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid #f0f0f0;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.related-products .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-color: #e0e0e0;
}

.related-products .nb-image-section {
    position: relative;
    padding-top: 100%;
    background: #f8f6f3;
    overflow: hidden;
}

.related-products .nb-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.related-products .product-card:hover .nb-image {
    transform: scale(1.05);
}

.related-products .nb-info {
    padding: 20px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
}

.related-products .nb-title-row {
    margin-bottom: 12px;
}

.related-products .nb-title {
    font-size: 16px;
    font-weight: 500;
    color: #111;
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.related-products .nb-bottom-row {
    margin-top: auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.related-products .nb-price {
    font-size: 18px;
    font-weight: 600;
    color: #111;
}

.related-products .nb-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #111;
    color: #fff;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    z-index: 1;
}

.product-link {
    text-decoration: none;
    color: inherit;
}

@media (max-width: 768px) {
    .product-detail {
        grid-template-columns: 1fr;
        min-height: auto;
    }

    .product-image {
        min-height: 60vh;
        height: 60vh;
        padding: 20px;
    }

    .product-image img {
        height: calc(60vh - 40px);
    }

    .product-info {
        min-height: auto;
        padding: 24px;
        border-left: none;
        border-top: 1px solid #ececec;
    }

    .product-info h2 {
        font-size: 1.8rem;
    }

    .size-options {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }

    .size-button {
        padding: 10px 0;
        font-size: 14px;
    }

    .variant-images {
        gap: 8px;
    }

    .variant-image {
        width: 40px;
        height: 40px;
    }

    .add-to-cart {
        padding: 16px;
        font-size: 15px;
    }

    .image-navigation {
        bottom: 60px;
    }

    .nav-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }    .related-products {
        padding: 40px 0;
        margin-top: 20px;
    }

    .related-products .container {
        padding: 0 15px;
    }

    .related-title {
        font-size: 24px;
        margin-bottom: 30px;
    }

    .related-products .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .related-products .nb-info {
        padding: 15px;
    }

    .related-products .nb-title {
        font-size: 14px;
        -webkit-line-clamp: 1;
        line-clamp: 1;
    }

    .related-products .nb-price {
        font-size: 16px;
    }
}

/* Size Guide Modal */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 1000;
}

.modal-backdrop.active {
    display: block;
}

.size-guide-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 32px;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    z-index: 1001;
    display: none;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
}

.size-guide-modal.active {
    display: block;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #111;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #888;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
}

.modal-tabs {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    border-bottom: 1px solid #ececec;
    padding-bottom: 16px;
}

.modal-tab {
    background: none;
    border: none;
    font-size: 15px;
    color: #888;
    cursor: pointer;
    padding: 8px 0;
    font-weight: 500;
    position: relative;
}

.modal-tab.active {
    color: #111;
}

.modal-tab.active::after {
    content: '';
    position: absolute;
    bottom: -17px;
    left: 0;
    width: 100%;
    height: 2px;
    background: #111;
}

.unit-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
}

.unit-btn {
    background: #f8f6f3;
    border: 1px solid #ececec;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    color: #888;
}

.unit-btn.active {
    background: #111;
    color: #fff;
    border-color: #111;
}

.size-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
}

.size-table th,
.size-table td {
    padding: 12px;
    text-align: center;
    border: 1px solid #ececec;
}

.size-table th {
    background: #f8f6f3;
    font-weight: 600;
    color: #111;
}

.size-table td {
    color: #666;
}

.size-table tr:first-child th {
    background: #111;
    color: #fff;
}

.modal-pagination {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
}

.page-btn {
    width: 36px;
    height: 36px;
    border: 1px solid #ececec;
    background: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #111;
    transition: all 0.2s;
}

.page-btn:hover {
    background: #f8f6f3;
}

@media screen and (max-width: 768px) {
    .product-detail {
        grid-template-columns: 1fr;
        min-height: auto;
    }

    .product-image {
        min-height: 60vh;
        height: 60vh;
        padding: 20px;
    }

    .product-image img {
        height: calc(60vh - 40px);
    }

    .product-info {
        min-height: auto;
        padding: 24px;
        border-left: none;
        border-top: 1px solid #ececec;
    }

    .product-info h2 {
        font-size: 1.8rem;
    }

    .size-options {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }

    .size-button {
        padding: 10px 0;
        font-size: 14px;
    }

    .variant-images {
        gap: 8px;
    }

    .variant-image {
        width: 40px;
        height: 40px;
    }

    .add-to-cart {
        padding: 16px;
        font-size: 15px;
    }

    .image-navigation {
        bottom: 60px;
    }

    .nav-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }    .related-products {
        padding: 40px 0;
        margin-top: 20px;
    }

    .related-products .container {
        padding: 0 15px;
    }

    .related-title {
        font-size: 24px;
        margin-bottom: 30px;
    }

    .related-products .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .related-products .nb-info {
        padding: 15px;
    }

    .related-products .nb-title {
        font-size: 14px;
        -webkit-line-clamp: 1;
        line-clamp: 1;
    }

    .related-products .nb-price {
        font-size: 16px;
    }
}
</style>

<div class="product-detail">
    <div class="product-image">
        <% 
        const productImages = [];
        productImages.push(product.image);
        product.colors.forEach(color => {
            productImages.push(`/uploads/${color.toLowerCase()}.jpg`);
        });
        %>
        <img src="<%= productImages[0] %>" alt="<%= product.name %>" id="mainImage">
        <div class="image-navigation">
            <button class="nav-btn prev" id="prevButton">&lt;</button>
            <button class="nav-btn next" id="nextButton">&gt;</button>
        </div>
        <div class="image-counter" id="imageCounter">01/<%= productImages.length.toString().padStart(2, '0') %></div>
    </div>
    <div class="product-info">
        <h2><%= product.name %></h2>
        <div class="product-rating">
            <div class="rating-stars">★★★★★</div>
            <span class="rating-count">5,495</span>
        </div>
        <div class="price"><%= product.price.toLocaleString() %> dh</div>
        <div class="taxes-info">Taxes included.</div>
        <hr>
        <div class="product-variants">            <div class="variant-title">Color: <span id="selectedColorText" style="font-weight:700"><%= product.colors[0] %></span></div>
            <div class="variant-images">
                <% product.colors.forEach(color => { %>
                    <img src="/uploads/<%= color.toLowerCase() %>" 
                         alt="<%= color %>" 
                         class="variant-image <%= color === product.colors[0] ? 'selected' : '' %>">
                <% }) %>
            </div>
        </div>
        <hr>
        <div class="size-selector">
            <div class="size-title">
                <h3>Size: <span style="font-weight:400;font-size:13px;color:#888">(US Size - Select size guide for other metrics)</span></h3>
                <a href="#" class="size-guide" id="sizeGuideLink">Size Guide</a>
            </div>
            <div class="size-options">                <% ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'].forEach(size => { %>
                    <button type="button" class="size-button" data-size="<%= size %>"><%= size %></button>
                <% }) %>
            </div>
        </div>        <form action="/cart/add/<%= product._id %>" method="POST" id="addToCartForm">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="color" id="selectedColor" value="<%= product.colors[0] %>">
            <input type="hidden" name="size" id="selectedSize" value="">
            <button type="submit" class="add-to-cart" disabled>Select Your Size</button>
        </form>
        <div class="shipping-info">Free standard shipping on all orders 990 DH and over.</div>
    </div>
</div>

<div class="related-products">
    <div class="container">
        <h3 class="related-title">You May Also Like</h3>
        <div class="products-grid">
            <% relatedProducts.forEach(product => { %>
                <a href="/products/<%= product._id %>" class="product-link">
                    <div class="product-card">
                        <div class="nb-image-section">
                            <% if (product.price === 99) { %>
                                <div class="nb-badge">NOW 990 DH</div>
                            <% } %>
                            <img src="<%= product.image %>" alt="<%= product.name %>" class="nb-image">
                        </div>
                        <div class="nb-info">
                            <div class="nb-title-row">
                                <h4 class="nb-title"><%= product.name %></h4>
                            </div>
                            <div class="nb-bottom-row">
                                <span class="nb-price"><%= product.price.toLocaleString() %> dh</span>
                            </div>
                        </div>
                    </div>
                </a>
            <% }); %>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="size-guide-modal" id="sizeGuideModal">
    <div class="modal-header">
        <h3 class="modal-title">Size Guide</h3>
        <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-tabs">
        <button class="modal-tab active" data-tab="size-chart">Size Chart</button>
        <button class="modal-tab" data-tab="how-to-measure">How to Measure</button>
    </div>
    <div class="unit-toggle">
        <button class="unit-btn active" data-unit="in">IN</button>
        <button class="unit-btn" data-unit="cm">CM</button>
    </div>
    <div class="tab-content active" id="size-chart">
        <table class="size-table">
            <tr>
                <th>Size</th>
                <th>XS</th>
                <th>S</th>
                <th>M</th>
                <th>L</th>
                <th>XL</th>
                <th>XXL</th>
            </tr>
            <tr>
                <th>Chest</th>
                <td>32-34</td>
                <td>34-36</td>
                <td>36-38</td>
                <td>38-40</td>
                <td>40-42</td>
                <td>42-44</td>
            </tr>
            <tr>
                <th>Waist</th>
                <td>26-28</td>
                <td>28-30</td>
                <td>30-32</td>
                <td>32-34</td>
                <td>34-36</td>
                <td>36-38</td>
            </tr>
            <tr>
                <th>Hips</th>
                <td>34-36</td>
                <td>36-38</td>
                <td>38-40</td>
                <td>40-42</td>
                <td>42-44</td>
                <td>44-46</td>
            </tr>
        </table>
    </div>
    <div class="tab-content" id="how-to-measure" style="display: none;">
        <div class="measurement-guide">
            <h4>How to Take Your Measurements</h4>
            <p>For best results, take measurements while wearing lightweight clothing or just underwear. Use a flexible measuring tape and keep it level around your body.</p>
            
            <h5>Chest</h5>
            <p>Measure around the fullest part of your chest, keeping the tape horizontal.</p>
            
            <h5>Waist</h5>
            <p>Measure around your natural waistline, keeping the tape comfortably loose.</p>
            
            <h5>Hips</h5>
            <p>Measure around the fullest part of your hips, usually about 8 inches below your waistline.</p>
        </div>
    </div>
    <div class="modal-pagination">
        <button class="page-btn" id="prevPage">&lt;</button>
        <button class="page-btn" id="nextPage">&gt;</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sizeButtons = document.querySelectorAll('.size-button');
    const variantImages = document.querySelectorAll('.variant-image');
    const addToCartButton = document.querySelector('.add-to-cart');
    const selectedColorInput = document.getElementById('selectedColor');
    const selectedSizeInput = document.getElementById('selectedSize');

    // Image navigation
    const mainImage = document.getElementById('mainImage');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const imageCounter = document.getElementById('imageCounter');
    let currentImageIndex = 0;

    const productImages = JSON.parse('<%- JSON.stringify(productImages) %>');

    function updateImage() {
        mainImage.src = productImages[currentImageIndex];
        imageCounter.textContent = `${(currentImageIndex + 1).toString().padStart(2, '0')}/${productImages.length.toString().padStart(2, '0')}`;
    }

    prevButton.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex - 1 + productImages.length) % productImages.length;
        updateImage();
    });

    nextButton.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex + 1) % productImages.length;
        updateImage();
    });    sizeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            sizeButtons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            selectedSizeInput.value = this.dataset.size;
            console.log('Size selected:', this.dataset.size);
            addToCartButton.textContent = 'Add to Cart';
            addToCartButton.disabled = false;
        });
    });    // Handle form submission
    document.getElementById('addToCartForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const size = selectedSizeInput.value;
        const color = selectedColorInput.value;

        if (!size || !color) {
            alert('Please select both size and color');
            return false;
        }

        // If validation passes, submit the form
        this.submit();
    });variantImages.forEach((img, index) => {
        img.addEventListener('click', function() {
            variantImages.forEach(image => image.classList.remove('selected'));
            this.classList.add('selected');
            const selectedColor = this.alt;
            selectedColorInput.value = selectedColor;
            document.getElementById('selectedColorText').textContent = selectedColor;
            console.log('Color selected:', selectedColor);
            // Update main image to show the selected color
            currentImageIndex = index;
            updateImage();
        });
    });

    // Size Guide Modal
    const modalBackdrop = document.getElementById('modalBackdrop');
    const sizeGuideModal = document.getElementById('sizeGuideModal');
    const modalClose = document.getElementById('modalClose');
    const sizeGuideButton = document.getElementById('sizeGuideLink');

    // Show modal
    sizeGuideButton.addEventListener('click', (e) => {
        e.preventDefault();
        modalBackdrop.classList.add('active');
        sizeGuideModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    });

    // Close modal functions
    const closeModal = () => {
        modalBackdrop.classList.remove('active');
        sizeGuideModal.classList.remove('active');
        document.body.style.overflow = '';
    };

    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', closeModal);
    sizeGuideModal.addEventListener('click', e => e.stopPropagation());

    // Tab Controls
    const tabs = document.querySelectorAll('.modal-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Hide all tab contents
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected tab content
            const tabId = tab.dataset.tab;
            document.getElementById(tabId).style.display = 'block';
        });
    });

    // Unit Toggle
    const unitButtons = document.querySelectorAll('.unit-btn');
    const sizeTableCells = document.querySelectorAll('.size-table td');
    const measurements = {
        in: {
            chest: ['32-34', '34-36', '36-38', '38-40', '40-42', '42-44'],
            waist: ['26-28', '28-30', '30-32', '32-34', '34-36', '36-38'],
            hips: ['34-36', '36-38', '38-40', '40-42', '42-44', '44-46']
        },
        cm: {
            chest: ['81-86', '86-91', '91-97', '97-102', '102-107', '107-112'],
            waist: ['66-71', '71-76', '76-81', '81-86', '86-91', '91-97'],
            hips: ['86-91', '91-97', '97-102', '102-107', '107-112', '112-117']
        }
    };

    unitButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Toggle active class
            unitButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Convert measurements
            const unit = button.dataset.unit;
            const rows = document.querySelectorAll('.size-table tr');
            
            rows.forEach((row, rowIndex) => {
                if (rowIndex > 0) { // Skip header row
                    const measurementType = row.querySelector('th').textContent.toLowerCase();
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, cellIndex) => {
                        cell.textContent = measurements[unit][measurementType][cellIndex];
                    });
                }
            });
        });
    });

    // Modal Pagination Controls
    const modalPrevBtn = document.getElementById('prevPage');
    const modalNextBtn = document.getElementById('nextPage');
    const tables = document.querySelectorAll('.size-table');
    let currentTableIndex = 0;

    const updateTableVisibility = () => {
        tables.forEach((table, index) => {
            table.style.display = index === currentTableIndex ? 'table' : 'none';
        });
        
        // Update button states
        modalPrevBtn.style.opacity = currentTableIndex === 0 ? '0.5' : '1';
        modalNextBtn.style.opacity = currentTableIndex === tables.length - 1 ? '0.5' : '1';
    };

    modalPrevBtn.addEventListener('click', () => {
        if (currentTableIndex > 0) {
            currentTableIndex--;
            updateTableVisibility();
        }
    });

    modalNextBtn.addEventListener('click', () => {
        if (currentTableIndex < tables.length - 1) {
            currentTableIndex++;
            updateTableVisibility();
        }
    });

    updateTableVisibility();
});
</script>

<%- include('partials/footer') %>